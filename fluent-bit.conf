##############################################
#           FLUENT BIT MAIN CONFIG
##############################################
[SERVICE]
    Daemon       off
    Log_Level    info
    Parsers_File parsers.conf
    HTTP_Server  On
    HTTP_Listen  0.0.0.0
    HTTP_Port    2020

##############################################
#           INPUT SECTIONS
##############################################
# ─── Docker container logs ──────────────────────────────
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Docker_Mode       On
    Refresh_Interval  2
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On

# ─── System logs (/var/log/syslog) ───────────────────────
[INPUT]
    Name              tail
    Path              /var/log/syslog
    Parser            syslog
    Tag               syslog.*
    Refresh_Interval  2

# ─── Auth logs (/var/log/auth.log) ───────────────────────
[INPUT]
    Name              tail
    Path              /var/log/auth.log
    Parser            authlog
    Tag               authlog.*
    Refresh_Interval  2

##############################################
#           FILTERS
##############################################
# ─── Extract container name automatically ───────────────
[FILTER]
    Name          parser
    Match         docker.*
    Key_Name      log
    Parser        docker
    Reserve_Data  On

# ─── Clean blank lines ──────────────────────────────────
[FILTER]
    Name    grep
    Match   *
    Exclude message ^\s*$

# ─── Add log_type based on source ───────────────────────
[FILTER]
    Name   modify
    Match  docker.*
    Add    source docker

[FILTER]
    Name   modify
    Match  syslog.*
    Add    source syslog

[FILTER]
    Name   modify
    Match  authlog.*
    Add    source authlog

##############################################
#           OUTPUTS
##############################################
# ─── Local stdout (debug purpose) ───────────────────────
[OUTPUT]
    Name   stdout
    Match  *
    Format json_lines

# ─── Loki output ────────────────────────────────────────
[OUTPUT]
    Name              loki
    Match             *
    Host              172.31.22.244
    Port              3100
    URI               /loki/api/v1/push
    Labels            job=fluentbit,source=ec2,container_name=system
    line_format        json

