version: "3.8"

services:
  scylla-db:
    image: scylladb/scylla:latest
    container_name: scylla-db
    ports:
      - "9042:9042"
    restart: unless-stopped
    command:
      - "--smp"
      - "1"
      - "--memory"
      - "750M"
      - "--overprovisioned"
      - "1"
      - "--authenticator"
      - "PasswordAuthenticator"
      - "--authorizer"
      - "CassandraAuthorizer"
    environment:
      - SCYLLA_AUTHENTICATOR=PasswordAuthenticator
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -u cassandra -p cassandra -e 'DESCRIBE KEYSPACES;' || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 120s

  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  migrate:
    image: scylladb/scylla:latest
    container_name: scylla-migrate
    depends_on:
      scylla-db:
        condition: service_healthy
    volumes:
      - ./init.cql:/init.cql
    entrypoint: >
      bash -c "
      echo '‚è≥ Waiting for ScyllaDB to accept CQL connections...' &&
      until cqlsh scylla-db -u cassandra -p cassandra -e 'DESCRIBE KEYSPACES;' >/dev/null 2>&1; do
        echo '‚è±Ô∏è Scylla not ready yet... retrying in 10s';
        sleep 10;
      done;
      echo '‚úÖ Scylla is ready. Running init.cql...' &&
      if cqlsh scylla-db -u cassandra -p cassandra -f /init.cql; then
        echo '‚úÖ ScyllaDB initialization completed successfully.';
        exit 0;
      else
        echo '‚ùå Migration failed. Check your init.cql file for errors.';
        cqlsh scylla-db -u cassandra -p cassandra -e 'DESCRIBE KEYSPACES;';
        exit 1;
      fi
      "
    restart: "no"

  salary-api:
    image: doc-salary-api:latest
    container_name: salary-api
    depends_on:
      migrate:
        condition: service_completed_successfully
      redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      # üîπ Database & Cache
      - SCYLLA_HOST=scylla-db
      - SCYLLA_PORT=9042
      - SCYLLA_KEYSPACE=employee_db
      - SCYLLA_USERNAME=cassandra
      - SCYLLA_PASSWORD=cassandra
      - REDIS_HOST=redis

      # üîπ OpenTelemetry Configuration (update IP to your monitoring EC2)
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://54.203.115.57:4319
      - OTEL_SERVICE_NAME=salary-api
      - OTEL_SDK_DISABLED=false

      # üîπ Prometheus Metrics
      - MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,prometheus
      - MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED=true

      # üîπ Logging & Spring Settings
      - SPRING_PROFILES_ACTIVE=debug
      - LOGGING_LEVEL_ORG_SPRINGFRAMEWORK=DEBUG
      - LOGGING_LEVEL_COM_DATACENTER=DEBUG
      - SPRING_DATA_CASSANDRA_CONNECTION_INIT_QUERY_TIMEOUT=10
      - SPRING_DATA_CASSANDRA_REQUEST_TIMEOUT=10000
      - SPRING_DATA_CASSANDRA_CONTACT_POINTS=scylla-db:9042
      - SPRING_DATA_CASSANDRA_KEYSPACE=employee_db
      - SPRING_DATA_CASSANDRA_LOCAL_DATACENTER=datacenter1

    volumes:
      - ./opentelemetry-javaagent.jar:/app/opentelemetry-javaagent.jar
    entrypoint:
      [
        "java",
        "-javaagent:/app/opentelemetry-javaagent.jar",
        "-Dotel.exporter.otlp.endpoint=http://54.203.115.57:4317",
        "-Dotel.service.name=salary-api",
        "-jar",
        "/app/app.jar"
      ]
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    ports:
      - "19100:9100"
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'

  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: fluent-bit
    user: root
    ports:
      - "24224:24224"
      - "24224:24224/udp"
      - "2020:2020"
    volumes:
      - /var/log:/var/log
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - ./parsers.conf:/fluent-bit/etc/parsers.conf:ro
    restart: unless-stopped
